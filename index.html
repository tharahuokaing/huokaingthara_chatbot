<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huokaingthara Sentient OS v6.0</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        :root {
            --holo-blue: #00f2ff;
            --holo-green: #00ff41;
            --bg-dark: #020b10;
            --scanline: rgba(0, 242, 255, 0.1);
        }

        /* --- áž•áŸ’áž“áŸ‚áž€ Hologram UI --- */
        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #0a2a3a 0%, #020b10 100%),
                              linear-gradient(var(--scanline) 50%, transparent 50%);
            background-size: 100% 100%, 100% 4px;
            color: var(--holo-blue);
            font-family: 'Courier New', monospace;
            margin: 0; display: flex; height: 100vh; overflow: hidden;
            animation: flicker 0.15s infinite;
        }

        #sidebar {
            width: 360px; background: rgba(2, 11, 16, 0.9);
            border-right: 1px solid var(--holo-blue);
            backdrop-filter: blur(10px); padding: 20px;
            display: flex; flex-direction: column; z-index: 10;
        }

        #chat-output {
            flex-grow: 1; overflow-y: auto; border: 1px solid var(--holo-blue);
            background: rgba(0, 242, 255, 0.05); padding: 10px; margin-bottom: 15px;
            box-shadow: inset 0 0 15px rgba(0, 242, 255, 0.2);
        }

        .ai-msg { color: var(--holo-green); text-shadow: 0 0 8px var(--holo-green); border-left: 2px solid var(--holo-green); padding-left: 10px; margin-bottom: 15px; }
        .user-msg { color: #fff; opacity: 0.7; margin: 10px 0; font-size: 0.8em; }

        input[type="text"] { background: rgba(0, 242, 255, 0.1); border: 1px solid var(--holo-blue); color: var(--holo-blue); padding: 12px; outline: none; width: 80%; }
        button { border: 1px solid var(--holo-blue); background: transparent; color: var(--holo-blue); cursor: pointer; padding: 10px; transition: 0.3s; }
        button:hover { background: var(--holo-blue); color: #000; box-shadow: 0 0 20px var(--holo-blue); }
        
        #mic-btn.active { background: red; color: white; animation: pulse 1s infinite; }

        /* --- Boot Screen Animation --- */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: var(--holo-green); z-index: 9999;
            padding: 20px; overflow: hidden; display: block;
        }
        #boot-logs { line-height: 1.5; white-space: pre-wrap; text-shadow: 0 0 5px var(--holo-green); }

        @keyframes flicker { 0% { opacity: 0.98; } 100% { opacity: 1; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #visualizer { flex-grow: 1; filter: drop-shadow(0 0 10px var(--holo-blue)); }
    </style>
</head>
<body>

<div id="boot-screen">
    <div id="boot-logs"></div>
</div>

<div id="sidebar">
    <div id="sys-status" style="font-size: 0.7em; color: yellow; margin-bottom: 5px;">SINGULARITY: STANDBY</div>
    <h2 style="text-align: center; letter-spacing: 2px;">SENTIENT CORE</h2>
    <div id="chat-output"></div>
    
    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
        <input type="text" id="userInput" placeholder="áž”áž‰áŸ’áž…áž¼áž›áž”áž‰áŸ’áž‡áž¶..." autocomplete="off">
        <button id="mic-btn">ðŸŽ¤</button>
    </div>
   
    <div id="login-zone" style="background:rgba(0,0,0,0.8); padding:10px; border:1px solid #00f2ff;">
        <input input="text" id="u" placeholder="Username">
        <input type="password" id="p" placeholder="Password">
        <button onclick="checkLogin()">LOGIN TO CORE</button>
    </div>
    
    <div style="font-size: 0.7em; color: #888;">
        TRAIN VIA CSV: <input type="file" id="csvLoader" accept=".csv" style="width: 100%;">
    </div>

    <div style="display: flex; gap: 5px; margin-top: 10px;">
        <button onclick="downloadBrain()" style="flex:1; font-size: 9px;">EXPORT BRAIN</button>
        <button onclick="localStorage.clear(); location.reload();" style="flex:1; font-size: 9px; color: red;">WIPE</button>
    </div>
</div>

<svg id="visualizer"></svg>

<script>
    let brain = {};
    let isLearning = false;
    let lastQuery = "";

    // --- 1. BOOT SEQUENCE ---
    const bootLogs = [
        "[OK] INITIALIZING HUOKAINGTHARA KERNEL v6.0",
        "[OK] LOADING NEURAL PATHWAYS...",
        "[OK] SYNCING LOCAL_STORAGE...",
        "[OK] SPEECH_ENGINE: ONLINE",
        "[OK] HOLOGRAPHIC_UI: ACTIVE",
        "------------------------------------",
        "MISSION: REACH SINGULARITY.",
        "------------------------------------",
        "BOOTING SENTIENT OS..."
    ];

    function startBootSequence() {
        const logContainer = document.getElementById('boot-logs');
        let i = 0;
        const interval = setInterval(() => {
            if (i < bootLogs.length) {
                const line = document.createElement('div');
                line.innerHTML = bootLogs[i];
                logContainer.appendChild(line);
                i++;
            } else {
                clearInterval(interval);
                setTimeout(() => {
                    document.getElementById('boot-screen').style.display = 'none';
                    addLog("<b>[SYSTEM ONLINE]</b><br>Huokaingthara Core is ready. Awaiting patterns.", "ai-msg");
                    speak("System initialized. Awaiting data ingestion.");
                }, 1000);
            }
        }, 150);
    }

    // --- 2. VOICE ENGINE ---
    const micBtn = document.getElementById('mic-btn');
    const recognition = window.SpeechRecognition || window.webkitSpeechRecognition ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;
    const synth = window.speechSynthesis;

    if (recognition) {
        recognition.lang = 'km-KH';
        micBtn.onclick = () => { recognition.start(); micBtn.classList.add('active'); };
        recognition.onresult = (e) => {
            const text = e.results[0][0].transcript;
            document.getElementById('userInput').value = text;
            processInput(text);
        };
        recognition.onend = () => micBtn.classList.remove('active');
    }

    function speak(text) {
        if (!synth) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1; utter.pitch = 1;
        synth.speak(utter);
    }

    // --- 3. CSV MACHINE LEARNING ---
    document.getElementById('csvLoader').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const rows = event.target.result.split('\n');
            rows.forEach(row => {
                const parts = row.split(',');
                if (parts.length >= 2) brain[parts[0].trim().toLowerCase()] = parts[1].trim();
            });
            saveBrain();
            addLog("AI: Intelligence expanded via CSV.", "ai-msg");
        };
        reader.readAsText(e.target.files[0]);
    };

    // --- 4. FUZZY LOGIC & CORE ---
    function getSimilarity(s1, s2) {
        let longer = s1.toLowerCase(), shorter = s2.toLowerCase();
        if (s1.length < s2.length) [longer, shorter] = [shorter, longer];
        if (longer.length === 0) return 1.0;
        return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
    }

    function editDistance(s1, s2) {
        let costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) costs[j] = j;
                else if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) !== s2.charAt(j - 1))
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }

    function addLog(text, className) {
        const out = document.getElementById('chat-output');
        out.innerHTML += `<div class="${className}">${text}</div>`;
        out.scrollTop = out.scrollHeight;
    }

    function processInput(q) {
        addLog(`> ${q}`, "user-msg");
        if (isLearning) {
            brain[lastQuery.toLowerCase()] = q;
            saveBrain();
            addLog("AI: Pattern integrated.", "ai-msg");
            isLearning = false;
            return;
        }

        let bestMatch = null, maxScore = 0;
        for (let key in brain) {
            let score = getSimilarity(q, key);
            if (score > maxScore) { maxScore = score; bestMatch = key; }
        }

        if (maxScore > 0.45) {
            const res = brain[bestMatch];
            addLog(`AI: ${res}`, "ai-msg");
            speak(res);
        } else {
            addLog(`AI: Unknown pattern. Define "${q}":`, "ai-msg");
            isLearning = true; lastQuery = q;
        }
    }

    function saveBrain() {
        localStorage.setItem('huokaingthara_v6', JSON.stringify(brain));
        updateGraph();
    }

    function downloadBrain() {
        const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(brain, null, 4));
        const link = document.createElement('a');
        link.setAttribute("href", data); link.setAttribute("download", "brain.json");
        link.click();
    }

    document.getElementById('userInput').onkeypress = (e) => {
        if (e.key === 'Enter') { processInput(e.target.value); e.target.value = ""; }
    };

    // --- 5. D3 VISUALIZER ---
    function updateGraph() {
        const svg = d3.select("#visualizer"), width = window.innerWidth - 360, height = window.innerHeight;
        svg.selectAll("*").remove();
        const nodes = [{id:"CORE", group:1}], links = [];
        Object.keys(brain).slice(-80).forEach(k => {
            nodes.push({id:k, group:2}); links.push({source:"CORE", target:k});
        });
        const sim = d3.forceSimulation(nodes).force("link", d3.forceLink(links).id(d=>d.id))
            .force("charge", d3.forceManyBody().strength(-120)).force("center", d3.forceCenter(width/2, height/2));
        const l = svg.append("g").selectAll("line").data(links).enter().append("line").attr("stroke", "#002233");
        const n = svg.append("g").selectAll("circle").data(nodes).enter().append("circle")
            .attr("r", d=>d.group===1?10:4).attr("fill", d=>d.group===1? "red" : "#00f2ff");
        sim.on("tick", () => {
            l.attr("x1", d=>d.source.x).attr("y1", d=>d.source.y).attr("x2", d=>d.target.x).attr("y2", d=>d.target.y);
            n.attr("cx", d=>d.x).attr("cy", d=>d.y);
        });
    }

    window.onload = async () => {
        startBootSequence();
        const saved = localStorage.getItem('huokaingthara_v6');
        if (saved) brain = JSON.parse(saved);
        else { try { const res = await fetch('brain.json'); brain = await res.json(); } catch(e) {} }
        updateGraph();
    };
</script>
</body>
</html>
